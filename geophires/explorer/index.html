<!DOCTYPE html>
<html>
<head>
    <title>GEOPHIRES Direct-Use Heat Explorer</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="lib/jquery-3.7.0.min.js"></script>
    <script src="lib/jquery.csv.js"></script>
    <link href="lib/mui.min.css" rel="stylesheet" type="text/css"/>
    <script src="lib/mui.min.js"></script>


    <link href="explorer.css" rel="stylesheet" type="text/css"/>

    <script src="util.js"></script>
    <script type="module" src="explorer.js"></script>

    <script>
        function setLoading(isLoading) {
            let loader = document.getElementById('loading')
            if (isLoading) {
                loader.classList.remove('hidden')
            } else {
                loader.classList.add('hidden')
            }

            setInputEnabled(document.querySelector('input[type="submit"]'), !isLoading)
            setInputEnabled(document.querySelector('textarea'), !isLoading)
        }

        function submitForm(oFormElement) {
            let xhr = new XMLHttpRequest();
            xhr.onload = function () {
                console.log('Got response', xhr.responseText, xhr)
                setLoading(false)

                let resultsText = ''
                if (xhr.status !== 200) {
                    resultsText = `Error: ${xhr.statusText}`
                } else {
                    resultsText = xhr.responseText
                }
                document.getElementById('results').innerText = resultsText
            }

            let parsed_params = JSON.parse(oFormElement.querySelector('textarea[name="geophires_input_parameters"]').value)

            xhr.open(oFormElement.method, oFormElement.getAttribute("action"))
            xhr.send(JSON.stringify({
                'geophires_input_parameters': parsed_params
            }))

            setLoading(true)

            //let hash_params = new URLSearchParams()
            //hash_params.set('geophires_input_parameters', JSON.stringify(parsed_params))
            //setUrlHash(hash_params.toString())

            return false
        }
    </script>
</head>
<body>

<div class="mui-container">
    <div class="mui-panel">

        <h1 class="mui--text-title">GEOPHIRES Direct-Use Heat Explorer</h1>

        <div class="mui--text-body1">
            <p>Click a facility on the map to see a pre-computed GEOPHIRES result. Modify the parameters and re-run to
                get a
                new
                result.</p>
            <p>Red markers indicate unit temperature plus 15 degrees Celcius is available at 3000m. Saturation of blue
                markers
                indicates how close temps at 3000m are to unit temperature - darker blue = closer to unit temp</p>
        </div>
    </div>
    <div class="mui-panel">

        <div id="map"></div>

        <div id="geophires-ui" class="mui-row">
            <div class="mui-col-md-6">
                <form
                        method="POST"
                        action="https://xi0du897va.execute-api.us-west-2.amazonaws.com/"
                        onsubmit="return submitForm(this);">
                    <h3>GEOPHIRES Parameters</h3>
                    <textarea id="geophires_input_parameters"
                              name="geophires_input_parameters"
                              class="mui-textfield"
                              rows="13"
                    ></textarea>
                    <input type="submit"
                           value="Run GEOPHIRES"
                           class="mui-btn mui-btn--primary mui-btn--raised"/>
                    <span id="loading" class="hidden">Loading...</span>

                </form>
            </div>

            <div id="results-container" class="mui-col-md-6">
                <h3>GEOPHIRES Summary/Result</h3>
                <pre id="results">Click a facility on the map to see its GEOPHIRES summary</pre>
            </div>
        </div>
    </div>
</div>
<!-- prettier-ignore -->
<script>(g => {
    var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document,
        b = window;
    b = b[c] || (b[c] = {});
    var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams,
        u = () => h || (h = new Promise(async (f, n) => {
            await (a = m.createElement("script"));
            e.set("libraries", [...r] + "");
            for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
            e.set("callback", c + ".maps." + q);
            a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
            d[q] = f;
            a.onerror = () => h = n(Error(p + " could not load."));
            a.nonce = m.querySelector("script[nonce]")?.nonce || "";
            m.head.append(a)
        }));
    d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n))
})
({key: "AIzaSyAfrygB1fSNIi8qb_1AAK-Upmy0ZPjX55k", v: "beta"});
</script>
</body>
</html>
