<!DOCTYPE html>
<html>
<head>
    <title>GEOPHIRES Direct-Use Heat Explorer</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="jquery-3.7.0.min.js"></script>
    <script src="jquery.csv.js"></script>


    <style>
        #map {
            width: 100%;
            min-height: 420px;
        }

        form {
            display: inline-block;
            vertical-align: top;
        }

        #results-container {
            display: inline-block;
            max-width: 45%;
            vertical-align: top;
            padding: 0.5em;
        }

        .hidden {
            visibility: hidden;
        }

    </style>
    <script type="module" src="explorer.js"></script>
    <script>
        function setInputEnabled(inputElt, isEnabled) {
            if (isEnabled) {
                inputElt.removeAttribute('disabled')
            } else {
                inputElt.setAttribute('disabled', 'true')
            }
        }

        function setLoading(isLoading) {
            let loader = document.getElementById('loading')
            if (isLoading) {
                loader.classList.remove('hidden')
            } else {
                loader.classList.add('hidden')
            }

            setInputEnabled(document.querySelector('input[type="submit"]'), !isLoading)
            setInputEnabled(document.querySelector('textarea'), !isLoading)
        }

        function submitForm(oFormElement) {
            let xhr = new XMLHttpRequest();
            xhr.onload = function () {
                console.log('Got response', xhr.responseText, xhr)
                setLoading(false)

                let resultsText = ''
                if (xhr.status !== 200) {
                    resultsText = `Error: ${xhr.statusText}`
                } else {
                    resultsText = xhr.responseText
                }
                document.getElementById('results').innerText = resultsText
            }

            let parsed_params = JSON.parse(oFormElement.querySelector('textarea[name="geophires_input_parameters"]').value)

            xhr.open(oFormElement.method, oFormElement.getAttribute("action"))
            xhr.send(JSON.stringify({
                'geophires_input_parameters': parsed_params
            }))

            setLoading(true)

            //let hash_params = new URLSearchParams()
            //hash_params.set('geophires_input_parameters', JSON.stringify(parsed_params))
            //setUrlHash(hash_params.toString())

            return false
        }

        function getExplorerData(){
            let dataFilePath = 'gtw-facility-analysis_2023-07-20-1689881853.csv'

            $.get( dataFilePath, function( csv_data ) {
                let data = $.csv.toObjects(csv_data)
                console.log('Got facility analysis data:', data )
            });
        }
    </script>
</head>
<body>
<h1>GEOPHIRES Explorer</h1>
<p>Click a facility on the map to see a pre-computed GEOPHIRES result. Modify the parameters and re-run to get a new
    result.</p>
<p>Red markers indicate unit temperature plus 15 degrees Celcius is available at 3000m. Saturation of blue markers indicates how close temps at 3000m are to unit temperature - darker blue = closer to unit temp</p>
<div id="map"></div>

<div id="geophires-ui">
    <form method="POST"
          action="https://xi0du897va.execute-api.us-west-2.amazonaws.com/"
          onsubmit="return submitForm(this);">
        <h3>GEOPHIRES Parameters</h3>
        <textarea id="geophires_input_parameters"
                  name="geophires_input_parameters"
                  rows="13"
                  cols="69"
        ></textarea>
        <br/>
        <input type="submit" value="Run GEOPHIRES"/>
        <span id="loading" class="hidden">Loading...</span>

    </form>

    <div id="results-container">
        <h3>GEOPHIRES Summary/Result</h3>
        <pre id="results"></pre>
    </div>
</div>

<!-- prettier-ignore -->
<script>(g => {
    var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document,
        b = window;
    b = b[c] || (b[c] = {});
    var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams,
        u = () => h || (h = new Promise(async (f, n) => {
            await (a = m.createElement("script"));
            e.set("libraries", [...r] + "");
            for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
            e.set("callback", c + ".maps." + q);
            a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
            d[q] = f;
            a.onerror = () => h = n(Error(p + " could not load."));
            a.nonce = m.querySelector("script[nonce]")?.nonce || "";
            m.head.append(a)
        }));
    d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n))
})
({key: "AIzaSyAfrygB1fSNIi8qb_1AAK-Upmy0ZPjX55k", v: "beta"});
</script>
</body>
</html>
